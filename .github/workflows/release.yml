name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Validate release
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
    - uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi

    - name: Validate version format
      run: |
        if [[ ! "${{ steps.version.outputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Invalid version format. Expected: v1.0.0"
          exit 1
        fi

    - name: Check if version exists
      run: |
        if git tag -l | grep -q "${{ steps.version.outputs.version }}"; then
          echo "Version ${{ steps.version.outputs.version }} already exists"
          exit 1
        fi

    - name: Generate changelog
      id: changelog
      run: |
        if [[ -f CHANGELOG.md ]]; then
          # Extract changelog for this version
          CHANGELOG=$(awk "/^## \[${{ steps.version.outputs.version }}\]/,/^## \[/" CHANGELOG.md | sed '/^## \[/d' | head -n -1)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "No CHANGELOG.md found, using commit messages since last tag"
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            git log $LAST_TAG..HEAD --pretty=format:"- %s" --no-merges >> $GITHUB_OUTPUT
          fi
        fi

  # Security audit before release
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: validate
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Run cargo audit
      run: |
        cargo install cargo-audit
        cargo audit

    - name: Run cargo deny
      run: |
        cargo install cargo-deny
        cargo deny check

  # Build release artifacts
  build:
    name: Build Release
    runs-on: ${{ matrix.os }}
    needs: [validate, security]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: your-binary-name
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            binary_name: your-binary-name
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: your-binary-name.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            binary_name: your-binary-name
          - os: macos-latest
            target: aarch64-apple-darwin
            binary_name: your-binary-name

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install musl tools (Linux)
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Build release
      run: |
        cargo build --release --target ${{ matrix.target }}
        mkdir -p release
        cp target/${{ matrix.target }}/release/${{ matrix.binary_name }} release/

    - name: Strip binary (Unix)
      if: matrix.os != 'Windows'
      run: |
        if command -v strip >/dev/null 2>&1; then
          strip release/${{ matrix.binary_name }}
        fi

    - name: Generate checksums
      run: |
        cd release
        shasum -a 256 * > checksums.txt
        cat checksums.txt

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.target }}
        path: release/

  # Build Docker image
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate, security]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      if: env.DOCKER_HUB_TOKEN != ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Login to GitHub Container Registry
      if: env.GITHUB_TOKEN != ''
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          your-username/your-repo
          ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [validate, security, build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Publish to crates.io
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        cargo login $CARGO_REGISTRY_TOKEN
        cargo publish

  # Publish GitHub Release
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, security, build, docker]
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts/ -type f -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate.outputs.version }}
        name: Release ${{ needs.validate.outputs.version }}
        body: |
          ## Changes in ${{ needs.validate.outputs.version }}

          ${{ needs.validate.outputs.changelog }}

          ## Installation

          Download the appropriate binary for your platform from the assets below.

          ### Docker

          ```bash
          docker pull your-username/your-repo:${{ needs.validate.outputs.version }}
          ```

          ### Cargo

          ```bash
          cargo install your-crate-name
          ```

          ### Homebrew (macOS)

          ```bash
          brew install your-repo
          ```

        files: release-assets/
        draft: false
        prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Update Homebrew formula (macOS)
  homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [github-release]
    if: startsWith(needs.validate.outputs.version, 'v') && !contains(needs.validate.outputs.version, '-')
    steps:
    - uses: actions/checkout@v4
      with:
        repository: your-username/homebrew-your-repo
        token: ${{ secrets.HOMEBREW_TOKEN }}

    - name: Update formula
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        SHA256=$(shasum -a 256 release-assets/*darwin* | cut -d' ' -f1)
        sed -i '' "s/sha256 \".*\"/sha256 \"$SHA256\"/g" Formula/your-repo.rb
        sed -i '' "s/version \".*\"/version \"$VERSION\"/g" Formula/your-repo.rb

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.HOMEBREW_TOKEN }}
        commit-message: "Update your-repo to ${{ needs.validate.outputs.version }}"
        title: "Update your-repo to ${{ needs.validate.outputs.version }}"
        body: |
          Updates your-repo to version ${{ needs.validate.outputs.version }}

          Download from: [GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }})
        branch: update-${{ needs.validate.outputs.version }}
        delete-branch: true

  # Update AUR package (Arch Linux)
  aur:
    name: Update AUR Package
    runs-on: ubuntu-latest
    needs: [github-release]
    if: startsWith(needs.validate.outputs.version, 'v') && !contains(needs.validate.outputs.version, '-')
    steps:
    - uses: actions/checkout@v4
      with:
        repository: your-username/aur-repo
        token: ${{ secrets.AUR_TOKEN }}
        ssh-key: ${{ secrets.AUR_SSH_KEY }}

    - name: Update PKGBUILD
      run: |
        VERSION="${{ needs.validate.outputs.version }}"
        sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD
        sed -i "s/pkgrel=.*/pkgrel=1/" PKGBUILD
        updpkgsums
        generate_SSH_config

    - name: Commit and push
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git commit -am "Update to ${{ needs.validate.outputs.version }}"
        git push

  # Publish documentation
  docs:
    name: Publish Documentation
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Generate documentation
      run: |
        cargo doc --no-deps --all-features

    - name: Upload documentation to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/doc
        destination_dir: ./docs/${{ needs.validate.outputs.version }}

  # Post-release
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [github-release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Update version in Cargo.toml
      run: |
        CARGO_TOML="Cargo.toml"
        VERSION="${{ needs.validate.outputs.version }}"
        NEXT_PATCH=$(echo $VERSION | awk -F. '{print $1"."$2"."$3+1}')
        sed -i.bak "s/^version = .*/version = \"$NEXT_PATCH-dev\"/" $CARGO_TOML
        rm $CARGO_TOML.bak

    - name: Update CHANGELOG.md for next version
      run: |
        if [[ -f CHANGELOG.md ]]; then
          DATE=$(date +%Y-%m-%d)
          # Prepend new section to CHANGELOG
          sed -i.bak "1i\\
          \\
            n## [Unreleased] - $DATE\\
            \\
            n### Added\\
            n### Changed\\
            n### Deprecated\\
            n### Removed\\
            n### Fixed\\
            n### Security\\
            n" CHANGELOG.md
          rm CHANGELOG.md.bak
        fi

    - name: Create Pull Request for next version
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: prepare for next development iteration"
        title: "Prepare for next development iteration"
        body: |
          Automated post-release preparation tasks
        branch: release-${{ needs.validate.outputs.version }}-post
        delete-branch: true
